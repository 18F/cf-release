set -e -x

#registrar information
cd ${BUILD_DIR}/cf-registrar-bundle-for-identity
BUNDLE_WITHOUT=development:test bundle package --all

#unpack Maven
cd ${BUILD_DIR}
tar zxvf maven/apache-maven-3.1.1-bin.tar.gz
export MAVEN_HOME=${BUILD_DIR}/apache-maven-3.1.1

# Make sure we can see uname
export PATH=$PATH:/bin:/usr/bin

if [ `uname` = "Darwin" ]; then
  if [ ! -d $JAVA_HOME ]; then
    echo "JAVA_HOME properly set is required for Mac OS builds."
    exit 1
  fi
else 
  #unpack Java
  mkdir java
  cd java
  tar zxvf ../uaa/openjdk-1.7.0-u40-unofficial-linux-amd64.tgz
  export JAVA_HOME=${BUILD_DIR}/java
fi

#setup Java and Maven paths
export PATH=$MAVEN_HOME/bin:$JAVA_HOME/bin:$PATH

#Maven options for building
export MAVEN_OPTS='-Xmx1g -XX:MaxPermSize=512m'

#build cloud foundry war
cd ${BUILD_DIR}/login
mvn clean
mvn -U -e -B package -DskipTests=true -Ddot.git.directory=${RELEASE_DIR}/src/login/.git
cp login-server/target/cloudfoundry-login-server-*.war ${BUILD_DIR}/login/cloudfoundry-login-server.war

#remove build resources
mvn clean

#clean up - so we don't transfer files we don't need
cd ${BUILD_DIR}
rm -rf apache-maven*
rm -rf java
rm -rf maven

#clean up source code, we don't need that anymore
rm -rf ${BUILD_DIR}/uaa/scim
rm -rf ${BUILD_DIR}/uaa/common
rm -rf ${BUILD_DIR}/uaa/gatling
rm -rf ${BUILD_DIR}/uaa/samples
rm -rf ${BUILD_DIR}/uaa/docs
rm -rf ${BUILD_DIR}/uaa/uaa

rm -f ${BUILD_DIR}/uaa/README.md
rm -f ${BUILD_DIR}/uaa/NOTICE
rm -f ${BUILD_DIR}/uaa/.run-script.sh
rm -f ${BUILD_DIR}/uaa/.travis.yml
rm -f ${BUILD_DIR}/uaa/pom.xml
rm -f ${BUILD_DIR}/uaa/LICENSE

rm -rf ${BUILD_DIR}/login/login-server
rm -rf ${BUILD_DIR}/login/login-server-common
rm -rf ${BUILD_DIR}/login/docs
rm -rf ${BUILD_DIR}/login/doc-server
rm -rf ${BUILD_DIR}/login/api-docs

rm -f ${BUILD_DIR}/login/README.md
rm -f ${BUILD_DIR}/login/NOTICE
rm -f ${BUILD_DIR}/login/.run-script.sh
rm -f ${BUILD_DIR}/login/.travis.yml
rm -f ${BUILD_DIR}/login/pom.xml
rm -f ${BUILD_DIR}/login/LICENSE
